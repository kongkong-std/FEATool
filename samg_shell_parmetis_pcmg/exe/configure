#!/bin/bash

# ----------------------------------------
# Help message
# ----------------------------------------
show_help() {
    cat << EOF
Usage: ./configure [OPTIONS]

Options:
  --with-gcc=PATH          Path to GCC installation (optional)
  --with-mpich=PATH        Path to MPICH installation (required)
  --with-petsc=PATH        Path to PETSc installation (required)
  --with-metis=PATH        Path to METIS installation (required)
  --with-parmetis=PATH     Path to ParMETIS installation (required)
  --with-cjson=PATH        Path to cJSON installation (required)
  --with-gklib=PATH        Path to GKlib installation (required)
  -h, --help               Show this help message and exit

Example:
  ./configure --with-mpich=/opt/mpich \
              --with-petsc=/home/user/petsc \
              --with-metis=/opt/metis \
              --with-parmetis=/opt/parmetis

This script generates config.mk for Makefile usage.
EOF
}

# ----------------------------------------
# If -h or --help, show help and exit
# ----------------------------------------
if [[ $1 == "-h" || $1 == "--help" ]]; then
    show_help
    exit 0
fi

echo "Configuring project..."

# ----------------------------------------
# Default values
# ----------------------------------------
GCC_DIR=""             # Optional
MPICH_DIR=""           # Required
PETSC_DIR=""           # Required
METIS_DIR=""           # Required
PARMETIS_DIR=""        # Required
CJSON_DIR=""           # Required
GKLIB_DIR=""           # Required

# ----------------------------------------
# Parse arguments
# ----------------------------------------
for arg in "$@"; do
    case $arg in
        --with-gcc=*)
            GCC_DIR="${arg#*=}"
            ;;
        --with-mpich=*)
            MPICH_DIR="${arg#*=}"
            ;;
        --with-petsc=*)
            PETSC_DIR="${arg#*=}"
            ;;
        --with-metis=*)
            METIS_DIR="${arg#*=}"
            ;;
        --with-parmetis=*)
            PARMETIS_DIR="${arg#*=}"
            ;;
        --with-cjson=*)
            CJSON_DIR="${arg#*=}"
            ;;
        --with-gklib=*)
            GKLIB_DIR="${arg#*=}"
            ;;
        *)
            echo "Unknown option: $arg"
            echo "Use --help to see valid options."
            exit 1
            ;;
    esac
done

# ----------------------------------------
# Check required parameters
# ----------------------------------------
missing=""

[[ -z "$MPICH_DIR" ]] && missing="${missing}\n  --with-mpich=PATH"
[[ -z "$PETSC_DIR" ]] && missing="${missing}\n  --with-petsc=PATH"
[[ -z "$METIS_DIR" ]] && missing="${missing}\n  --with-metis=PATH"
[[ -z "$PARMETIS_DIR" ]] && missing="${missing}\n  --with-parmetis=PATH"
[[ -z "$CJSON_DIR" ]] && missing="${missing}\n  --with-cjson=PATH"
[[ -z "$GKLIB_DIR" ]] && missing="${missing}\n  --with-gklib=PATH"

if [[ -n "$missing" ]]; then
    echo "Error: missing required options: $missing"
    echo "Use --help to see usage."
    exit 1
fi

# ----------------------------------------
# GCC handling (optional)
# ----------------------------------------
if [[ -z "$GCC_DIR" ]]; then
    echo "No GCC path specified, using system GCC."
    GCC_DIR=$(dirname $(which gcc) | sed 's:/bin$::')
else
    echo "Using specified GCC path: $GCC_DIR"
fi

# ----------------------------------------
# Display summary
# ----------------------------------------
echo "-------------------------------------------"
echo "Configuration summary:"
echo "  GCC_DIR       = $GCC_DIR (optional)"
echo "  MPICH_DIR     = $MPICH_DIR"
echo "  PETSC_DIR     = $PETSC_DIR"
echo "  METIS_DIR     = $METIS_DIR"
echo "  PARMETIS_DIR  = $PARMETIS_DIR"
echo "  CJSON_DIR     = $CJSON_DIR"
echo "  GKLIB_DIR     = $GKLIB_DIR"
echo "-------------------------------------------"

# ----------------------------------------
# Generate config.mk
# ----------------------------------------
cat > config.mk << EOF
# Auto-generated by configure

GCC_DIR      = $GCC_DIR
MPICH_DIR    = $MPICH_DIR
PETSC_DIR    = $PETSC_DIR
METIS_DIR    = $METIS_DIR
PARMETIS_DIR = $PARMETIS_DIR
CJSON_DIR    = $CJSON_DIR
GKLIB_DIR    = $GKLIB_DIR
EOF

echo "Generated config.mk"
echo "Done."
